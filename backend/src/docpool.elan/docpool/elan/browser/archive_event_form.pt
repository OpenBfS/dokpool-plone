<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      lang="en"
      metal:use-macro="context/@@main_template/macros/master"
      xml:lang="en"
      i18n:domain="docpool.elan"
>
  <body>

    <metal:content-core fill-slot="main">
      <metal:content-core define-macro="main">
        <tal:def tal:define="
                   items python: view.items;
                   toLocalizedTime nocall: plone_view/toLocalizedTime;
                   _is nocall: context/@@is;
                 ">

          <form id="archive_event_form"
                action="#"
                method="post"
                name="archive_event_form"
                tal:attributes="
                  action request/URL;
                "
          >

            <input name="form.uid"
                   type="hidden"
                   tal:attributes="
                     value python: view.uid;
                   "
            />

            <div class="alert alert-danger"
                 role="alert"
                 tal:condition="python: view.archiving_info and not view.archiving_info['finished']"
            >
              <p><strong i18n:translate="">Watch out:</strong>
                <span i18n:translate="">This event is already being archived by</span>
                ${python: view.archiving_info["user"]}.<br />
                <span i18n:translate="">Start time:</span>
                ${python: toLocalizedTime(view.archiving_info["started"], long_format=True)}</p>

              <p i18n:translate="">After some minutes you can reload this page in your browser
                in order to see, if the process has finished or is still running.</p>
              <input class="btn btn-danger activate-spinner"
                     name="form.button.restart"
                     type="submit"
                     value="Restart"
                     tal:condition="python: _is.admin"
                     i18n:attributes="value label_restart;title"
              />
            </div>



            <tal:archive tal:condition="python: view.__name__=='archiveAndClose'">
              <h1 i18n:translate="">Archive Event</h1>
              <p><span i18n:translate="subtitle_archive">Archive event</span>
                <em>${python: context.title}</em>
                <span i18n:translate="subtitle_with">with</span>
                ${python: len(items)}
                <span i18n:translate="subtitle_entries">entries</span>.</p>
              <p i18n:translate="">The following happens when archiving:</p>
              <ul>
                <li i18n:translate="">All content for this event is saved in an archive.</li>
                <li i18n:translate="">Original content is moved to the archive.</li>
                <li i18n:translate="">Entries that are also assigned to other events are copied into the archive instead of moved.</li>
                <li i18n:translate="">The event and its journals are moved to the archive.</li>
                <li i18n:translate="">The event state is set to "closed".</li>
              </ul>
            </tal:archive>

            <tal:snapshot tal:condition="python: view.__name__=='snapshot'">
              <h1 i18n:translate="">Snapshot Event</h1>
              <p><span i18n:translate="subtitle_snapshot">Create a snapshot of the event</span>
                <em>${python: context.title}</em>
                <span i18n:translate="subtitle_with">with</span>
                ${python: len(items)}
                <span i18n:translate="subtitle_entries">entries</span>.</p>
              <p i18n:translate="">The following happens when creating a snapshot:</p>
              <ul>
                <li i18n:translate="">Original content is moved to the archive.</li>
                <li i18n:translate="">Entries that are also assigned to other events are copied into the archive instead of moved.</li>
                <li i18n:translate="">The event and its journals are copied to the archive.</li>
                <li i18n:translate="">The event state (active/inactive) is maintained.</li>
                <li i18n:translate="">Active Journals are purged.</li>
              </ul>
            </tal:snapshot>

            <p i18n:translate="">Depending on the number of entries in this event this can take an hour or longer.</p>

            <p i18n:translate="timeout-help"><strong>Important:</strong><br />
            After some minutes, an error-message "Error 503 Backend fetch failed" may appear in your browser.
            This does not mean that the process failed but that a timeout has happened.
            Please keep waiting a couple of minutes and reload this page in your browser.
            You will see if the process has finished or is still runnning.
            </p>

            <div class="formControls">
              <input class="context btn btn-primary activate-spinner"
                     name="form.button.submit"
                     title=""
                     type="submit"
                     value="Archive"
                     i18n:attributes="value label_archive;title"
              />
              <input class="btn btn-secondary"
                     name="form.button.cancel"
                     type="submit"
                     value="Cancel"
                     i18n:attributes="value;title"
                     i18n:domain="plone"
              />
            </div>

            <div class="card"
                 tal:condition="python: _is.admin_or_contentadmin and view.full_archiving_info"
            >
              <div class="card-body">
                <a class="btn btn-secondary"
                   aria-controls="collapseDebug"
                   aria-expanded="false"
                   href="#collapseDebug"
                   role="button"
                   data-bs-toggle="collapse"
                   i18n:translate=""
                >
                Show Debug-Info
                </a>
                <div class="collapse"
                     id="collapseDebug"
                >
                  <dl class="row"
                      tal:repeat="info python: view.full_archiving_info"
                  >
                    <tal:block tal:repeat="key python: info.keys()">
                      <dt class="col-sm-2"
                          tal:content="python: key"
                      ></dt>
                      <dd class="col-sm-10"
                          tal:content="python: info[key]"
                      ></dd>
                    </tal:block>
                  </dl>
                  <input class="btn btn-danger"
                         name="form.button.purge"
                         type="submit"
                         value="Purge"
                         tal:condition="python: _is.admin"
                         i18n:attributes="value label_purge;title"
                  />
                </div>
              </div>
            </div>

          </form>
        </tal:def>
      </metal:content-core>
    </metal:content-core>

  </body>
</html>
