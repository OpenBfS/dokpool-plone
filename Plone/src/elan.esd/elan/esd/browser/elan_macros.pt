<html xmlns:tal="http://xml.zope.org/namespaces/tal" 
     xmlns:metal="http://xml.zope.org/namespaces/metal"
     xmlns:i18n="http://xml.zope.org/namespaces/i18n" 
     i18n:domain="elan.esd">
    <body>
       
	<div id="scenario_box" metal:define-macro="scenario_table"
										  tal:define="possible_scenarios view/scenarios;
										              selected_scenarios view/selected_scenarios;
													  readonly request/ajax_load|nothing"
										  tal:condition="possible_scenarios">
      <form name="scenarios" method="post" class="scenario_selection"
          tal:attributes="action string:selectScenarios">
          <p tal:condition="not:selected_scenarios" i18n:translate="">Please select at least one scenario!</p>
            <table class="scenario_table" >
            <tal:loop tal:repeat="scenario possible_scenarios">
            <tr  tal:define="exercise scenario/exercise;
                             inactive python:scenario.status == 'inactive';
                             selected python:scenario.getId() in selected_scenarios;
                             toLocalizedTime nocall: context/@@plone/toLocalizedTime;" 
                 tal:attributes="class python:(exercise and 'exercise ' or '') + (selected and 'sselected  ' or '') + (inactive and 'inactive ' or '')">
            <td>
            <input type="checkbox" name="scnrs:list"
                   tal:attributes="value    scenario/getId;
                                   title    scenario/Title;
                                   disabled python:readonly and 'disabled' or None;
                                   checked python:'checked' if scenario.getId() in selected_scenarios else None;"
                   onclick="this.form.submit()"                            
                                    />
            </td>
			<tal:def define="mi python:scenario.modInfo();
			                           date python:mi[0];
			                           uinfo python:mi[1]">            
            <td class="scenario_desc"><tal:if condition="exercise"><span class="exerciseflag" i18n:translate="">++++ Exercise ++++</span> </tal:if><span class="scentitle" tal:attributes="title python:'%s %s ' % (uinfo, toLocalizedTime(date, long_format=1))" tal:content="string:${scenario/Title}">Event1</span><tal:if condition="python: selected and scenario.Description()"><span class="scendesc"> - <tal:var replace="scenario/Description"/></span></tal:if>
                    <span class="uinfo"><tal:var tal:condition="uinfo" replace="structure string:${uinfo}, "/> <tal:var replace="python:toLocalizedTime(date, long_format=1)"/> (<tal:var i18n:translate="">LT</tal:var>)</span>
            </td>
            </tal:def>               
            </tr>
            </tal:loop>
            </table>  
                <input tal:condition="not:readonly"
                                        type="hidden"
                                        name="form.button.Save"
                                        class="context"
                                        value="Filter"
                                        i18n:attributes="value" />
        </form>
        
		</div>
			  
        <div metal:define-macro="cat_filter" class="cat_filter" tal:define="selected view/selected_categories">
			<form name="categories" method="post" class="category_selection"
				tal:attributes="action string:selectCategories">
				<!-- label for="scnrs" i18n:translate="">Show content only for:</label-->
			    <div class="multiselection">
			    <select multiple="multiple" id="cat_select" name="cats" size="5">
			    <tal:loop tal:repeat="category view/available_categories">
			                       <option      tal:attributes="value    category/Title;
			                                                    selected python:'selected' if category.Title in selected else None;"

			    					tal:content="category/Title">Category</option>
			    </tal:loop>
			    </select>
			    </div>
				<input
			                            type="submit"
			                            name="form.button.Save"
			                            class="context"
			                            value="Filter"
			                            i18n:attributes="value" />
                <input onclick="jQuery('#cat_select option').removeAttr('selected');"
                                        type="submit"
                                        name="form.button.Save"
                                        class="context"
                                        value="All"
                                        i18n:attributes="value" />
			</form>
            <div class="cat_info">
            <span><i18n:text translate="">Current filter:</i18n:text> <tal:var replace="python:', '.join(selected)"/></span>
            </div>         
        </div>
        
        <div tal:omit-tag="" metal:define-macro="doccollection">
        <metal:listingmacro define-macro="listing">
        <tal:results define="b_start python:request.get('b_start', 0);
                             batch python:context.results(b_start=b_start);
                             site_properties context/portal_properties/site_properties;
                             use_view_action site_properties/typesUseViewActionInListings|python:();
                             isAnon context/@@plone_portal_state/anonymous;
                             normalizeString nocall: context/plone_utils/normalizeString;
                             toLocalizedTime nocall: context/@@plone/toLocalizedTime;
                             show_about python:not isAnon or site_properties.allowAnonymousViewAbout;
                             navigation_root_url context/@@plone_portal_state/navigation_root_url;
                             pas_member context/@@pas_member;
                             buttons python:[]">
        <tal:listing condition="batch">

          <table id="sortable"
                 class="listing responsive"
                 summary="Content listing"
                 i18n:attributes="summary summary_content_listing;"
                 tal:define="isOverview python:here.getId()=='overview'">
            <thead>
               <metal:header_slot metal:define-slot="listingheader">
                 <th class="nosort actions" tal:condition="python:False"></th>
                 <th class="nosort title" i18n:translate="">Title / Description / Text</th>
                 <th class="nosort metadata" i18n:translate="">Metadata</th>
              </metal:header_slot>
            </thead>

            <tbody >
                <tal:items tal:repeat="edoc batch">
                   <tr tal:define="oddrow  python:repeat['edoc'].index % 2 == 0;
                   				   item_id edoc/getId;
                   				   item_obj edoc/getObject|nothing;
                   				   isFolder edoc/is_folderish;
                				   item_folder_class python:isFolder and 'folder' or ''"
                       tal:attributes="class string:itemRow $item_folder_class';
                                       id item_id;" >
                     
                           <metal:block define-slot="entry">
                            <tal:if condition="nocall:item_obj">
       						<tal:insertview replace="structure python:item_obj.restrictedTraverse('@@listitem')(edoc=edoc,isOverview=isOverview,isCollection=True,myfolder=context,buttons=buttons)"/>
                    	   </tal:if>
                    	   </metal:block>
                   </tr>
                </tal:items>
            </tbody>
		</table>
            <div metal:use-macro="context/batch_macros/macros/navigation" />

        </tal:listing>
        <metal:empty metal:define-slot="no_items_in_listing">
            <p class="discreet"
               tal:condition="not: batch"
               i18n:translate="description_no_items_in_folder">
                There are currently no items in this folder.
            </p>
        </metal:empty>

        </tal:results>
        </metal:listingmacro>
        
        </div>
        
      <div tal:omit-tag="" metal:define-macro="transferEvents">  
          <span tal:define="transfers elanobj/transferEvents" tal:condition="transfers">
          <tal:loop repeat="transfer transfers">
          <span class="transferlog" tal:attributes="title string:${transfer/by} ${transfer/time} (${transfer/esd})" 
              tal:content="python:transfer['type'] == 'send' and '--> %s' % transfer['esd'] or '<-- %s' % transfer['esd']"></span>
          </tal:loop>
          </span>
      </div>  
        
    <metal:macro define-macro="docdata_meta" i18n:domain="elan.esd" tal:define="toLocalizedTime nocall: context/@@plone/toLocalizedTime;">
          <span tal:condition="python:context.mdate and (toLocalizedTime(context.mdate, long_format=1) != toLocalizedTime(context.created, long_format=1))">
             <i18n:txt translate="">modified:</i18n:txt>
             <span><tal:var replace="python:str(toLocalizedTime(context.mdate, long_format=1))"/> <tal:var i18n:translate="">LT</tal:var></span>, <span tal:content="structure python:context.modified_by" />
          </span>
          <br>
          <i18n:txt translate="">created:</i18n:txt>
          <span><tal:var replace="python:str(toLocalizedTime(context.created(), long_format=1))"/> <tal:var i18n:translate="">LT</tal:var></span>, <span tal:content="structure python:context.created_by" />
          <br>
        
          <tal:if tal:define="scns elanobj/getScenarioNames|nothing" tal:condition="scns">
          <label i18n:translate="">Belongs to scenario:</label>
          <span tal:content="python:', '.join(scns)" />
          <br>
          </tal:if>
    </metal:macro>

    <metal:macro define-macro="docdata" i18n:domain="elan.esd">
          <div metal:use-macro="here/@@elan.macros/macros/docdata_meta"/>   
          <tal:if condition="cat" define="cat elanobj/category">
          <label i18n:translate="">Content from:</label>
          <span tal:content="python: ', '.join(cat)" />
          <br>
          </tal:if>
          <div metal:use-macro="here/@@elan.macros/macros/transferEvents"/>   
          <br>
          <tal:if condition="htmltext" define="htmltext context/text/output">
          <label i18n:translate="">Content:</label>
          <span tal:attributes="id string:html_${context/getId}" tal:content="structure htmltext" />
          </tal:if>
    </metal:macro>
    
    <metal:macro define-macro="docfiles" i18n:domain="elan.esd">
          <span tal:define="files context/getFiles" tal:condition="files">
            <label i18n:translate="">Files:</label>
            <ul tal:define="multiple_files python:len(files) > 1">
             <span tal:repeat="d files">
              <li><a href="" target="_blank" tal:attributes="href python:d.absolute_url()"
                                            tal:content="structure python:d.title_or_id()">documents</a> 
                <font size="1">
                  (<span tal:content="python:d.file.contentType" />,&nbsp;<span tal:content="python:d.getObjSize(None, d.file.size)" />)
                </font>
                <tal:if condition="python:multiple_files and edit_allowed">
                   <tal:block tal:define="quoted_id python: view.quote_plus(d.getId());">
                    <a href=""
                       title="Move item up"
                       i18n:attributes="title title_move_item_up;"
                       tal:attributes="href string:${view/base_url}/change_position?position=up&amp;id=${quoted_id}&amp;ptype=File">
                      &#9650;
                    </a>
                    &nbsp;
                    <a href=""
                       title="Move item down"
                       i18n:attributes="title title_move_item_down;"
                       tal:attributes="href string:${view/base_url}/change_position?position=down&amp;id=${quoted_id}&amp;ptype=File">
                      &#9660;
                    </a>
                   </tal:block>
              </tal:if>          
              </li>  
             </span>
            </ul>
          </span>    
    </metal:macro>
    <metal:macro define-macro="docimages" i18n:domain="elan.esd">
        
          <span tal:define="images context/getImages" tal:condition="images">
            <label i18n:translate="">Images:</label>
            <table border="0">
            <tr tal:define="multiple_images python:len(images) > 1">
            <span tal:repeat="b images">
              <span tal:condition="python:b.getId() != 'icpdf.gif'">
              <td width="120" valign="top">
              <span tal:content="structure python:b.title_or_id()">images</span>&nbsp;&nbsp;<br><br>
              <a href="" tal:attributes="href python:b.absolute_url()" target="_blank">             
                 <img tal:attributes="src python:'/'.join(b.getPhysicalPath()) + '/@@images/image/preview'" border="0" width="80%" height="80%"><br>
              </a>
              <font size="1">
                 <span tal:content="python:b.image.contentType" /><br>
                 (<span tal:content="python:b.getObjSize(None,b.image.size)" />)<br><br>
              </font>
            
              <font size="1">
                <span tal:condition="python:b.Description()"
                      tal:content="python:b.Description()" />
              </font>
              <tal:if condition="python:multiple_images and edit_allowed">
                   <tal:block tal:define="quoted_id python: view.quote_plus(b.getId());">
                    <a href=""
                       title="Move item up"
                       i18n:attributes="title title_move_item_up;"
                       tal:attributes="href string:${view/base_url}/change_position?position=up&amp;id=${quoted_id}&amp;ptype=Image">
                      &#9668;
                    </a>
                    &nbsp;
                    <a href=""
                       title="Move item down"
                       i18n:attributes="title title_move_item_down;"
                       tal:attributes="href string:${view/base_url}/change_position?position=down&amp;id=${quoted_id}&amp;ptype=Image">
                      &#9658;
                    </a>
                   </tal:block>  
              </tal:if>          
              </td>
              </span>
            </span>
            </tr>       
          </table>
          <br><br>
         </span>    
    </metal:macro>

      <div tal:omit-tag="" metal:define-macro="elandoc" i18n:domain="elan.esd">
      
	      <div metal:use-macro="here/@@elan.macros/macros/docdata"/>    
	       
	      <br><br>
          <div metal:use-macro="here/@@elan.macros/macros/docfiles"/>   
	      <br><br>  
          <div metal:use-macro="here/@@elan.macros/macros/docimages"/>   
	      
    </div>        
      
    <metal:macro define-macro="docactions" i18n:domain="elan.esd">
          <tal:if condition="python: not (isCollection or individual or unknown) and not context.isArchive()">
              <tal:loop repeat="action actions" define="actions context/workflowActions">
                  <a  class="wf_action action" href=""
                  onclick=""
                  title=""
                  tal:define="a_id action/id;
                      a_title action/title;
                      a_icon action/icon;
                      alert_msg python:context.translate('alert_' + a_id + '_popup', default='Do you really want to publish this document?', domain='elan.esd', escape_for_js=True)"
                  tal:attributes="onclick string:return confirm('${context/Title}: ${alert_msg}');
                      href python:'%s/change_state?id=%s&action=%s' % (myfolder.absolute_url(), context.getId(), a_id);
                      title a_title;
                      ">
                  <img src="" tal:attributes="src string:${context/portal_url}/${a_icon}"/> 
                 </a>
          </tal:loop>
         </tal:if>
         <tal:if condition="python: not context.isArchive() and transferable and elanobj.allowedTargets()">
          <a class="transfer action pat-plone-modal" tal:condition="python: not context.isIndividual()" 
              href=""
              title="Transfer"
              tal:attributes="href python:'%s/elandocument_transfer_form?id=%s' % ('/'.join(edocobj.absolute_url().split('/')[:-1]), context.getId())"
              i18n:attributes="title">
              <img src="" tal:attributes="src string:${context/portal_url}/publish.png"/> 
          </a>
        </tal:if>
        <tal:cond condition="python: not (isCollection or context.isArchive())">
            <a tal:condition="nocall:unknown_scen" href=""
                title="Edit unknown scenario"
                tal:attributes="href unknown_scen/absolute_url"
                i18n:attributes="title">
                <img src="" tal:attributes="src string:${context/portal_url}/publish.png"/> 
            </a>
            <a tal:condition="nocall:unknown_dt" href=""
                title="Edit unknown doc type"
                tal:attributes="href unknown_dt/absolute_url"
                i18n:attributes="title">
                <img src="" tal:attributes="src string:${context/portal_url}/publish.png"/> 
            </a>
        </tal:cond>
        
     </metal:macro>
     
     <metal:macro define-macro="docmetadata" i18n:domain="elan.esd">
         <tal:if i18n:domain="elan.esd" tal:define="scns elanobj/getScenarioNames|nothing" tal:condition="scns">
             <b><tal:var i18n:translate="">Event:</tal:var> <tal:var content="python:', '.join(scns)" /></b><br>
         </tal:if>
            <tal:if condition="item_type">
             <i><span tal:content="string:${item_cat} (${item_type})" /></i>
            </tal:if>

          <div metal:use-macro="here/@@dp.macros/macros/content-metadata"/>

          <span tal:condition="context/hasComments">
              <b><u><a href="" title="" tal:attributes="title python:'show document';
                                                  href string:javascript:go_to('${item_url}');">
                   <i18n:txt translate="">There are comments.</i18n:txt>
              </a></u></b>
          </span>
          <div metal:use-macro="here/@@elan.macros/macros/transferEvents"/>
     </metal:macro>
     			
    </body>
</html>
